%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef unbatchedplan fill:#dff,stroke-width:1px,color:#000
    classDef sideeffectplan fill:#fcc,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left


    %% plan dependencies
    PgSelect17[["PgSelect[17∈0] ➊<br />ᐸmessages+1ᐳ"]]:::plan
    Object13{{"Object[13∈0] ➊<br />ᐸ{pgSettings,withPgClient}ᐳ"}}:::plan
    Lambda15[["Lambda[15∈0] ➊<br />ᐸincludeArchivedConditionᐳ"]]:::unbatchedplan
    Connection14{{"Connection[14∈0] ➊<br />ᐸ10ᐳ"}}:::plan
    Lambda16{{"Lambda[16∈0] ➊<br />ᐸparseCursorᐳ"}}:::plan
    Constant32{{"Constant[32∈0] ➊<br />ᐸ3ᐳ"}}:::plan
    Lambda15 -->|rejectNull| PgSelect17
    Object13 & Connection14 & Lambda16 & Constant32 --> PgSelect17
    Object25{{"Object[25∈0] ➊<br />ᐸ{first,last,offset,hasMore}ᐳ"}}:::plan
    Access20{{"Access[20∈0] ➊<br />ᐸ17.hasMoreᐳ"}}:::plan
    Constant32 & Access20 --> Object25
    Constant32 & Lambda16 --> Connection14
    Object21{{"Object[21∈0] ➊<br />ᐸ{first,last,hasMore}ᐳ"}}:::plan
    Constant32 & Access20 --> Object21
    PgSelect27[["PgSelect[27∈0] ➊<br />ᐸmessages(aggregate)ᐳ"]]:::plan
    Lambda15 -->|rejectNull| PgSelect27
    Object13 & Connection14 --> PgSelect27
    Access11{{"Access[11∈0] ➊<br />ᐸ2.pgSettingsᐳ"}}:::plan
    Access12{{"Access[12∈0] ➊<br />ᐸ2.withPgClientᐳ"}}:::plan
    Access11 & Access12 --> Object13
    __Value2["__Value[2∈0] ➊<br />ᐸcontextᐳ"]:::plan
    __Value2 --> Access11
    __Value2 --> Access12
    Constant7{{"Constant[7∈0] ➊<br />ᐸ'INHERIT'ᐳ"}}:::plan
    Constant7 --> Lambda15
    Constant33{{"Constant[33∈0] ➊<br />ᐸ'WyJmMGIyOGM5NGMxIiwiZjE3MGYxNzAtMDAwMC0wMDAwLTAwMDAtYjBiMDAᐳ"}}:::plan
    Constant33 --> Lambda16
    PgPageInfo18{{"PgPageInfo[18∈0] ➊"}}:::plan
    Connection14 --> PgPageInfo18
    PgSelect17 --> Access20
    Lambda22{{"Lambda[22∈0] ➊<br />ᐸhasNextPageCbᐳ"}}:::plan
    Object21 --> Lambda22
    Lambda26{{"Lambda[26∈0] ➊<br />ᐸhasPreviousPageCbᐳ"}}:::plan
    Object25 --> Lambda26
    First28{{"First[28∈0] ➊"}}:::plan
    PgSelectRows29[["PgSelectRows[29∈0] ➊"]]:::plan
    PgSelectRows29 --> First28
    PgSelect27 --> PgSelectRows29
    PgSelectSingle30{{"PgSelectSingle[30∈0] ➊<br />ᐸmessagesᐳ"}}:::plan
    First28 --> PgSelectSingle30
    PgClassExpression31{{"PgClassExpression[31∈0] ➊<br />ᐸcount(*)ᐳ"}}:::plan
    PgSelectSingle30 --> PgClassExpression31
    __Value4["__Value[4∈0] ➊<br />ᐸrootValueᐳ"]:::plan

    %% define steps

    subgraph "Buckets for queries/connections/pagination-before-last-pagination-only"
    Bucket0("Bucket 0 (root)<br /><br />1: <br />ᐳ: 6, 7, 11, 12, 32, 33, 13, 16, 14, 18<br />2: Lambda[15]<br />3: PgSelect[17], PgSelect[27]<br />ᐳ: 20, 21, 22, 25, 26<br />4: PgSelectRows[29]<br />ᐳ: 28, 30, 31"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value2,__Value4,Constant7,Access11,Access12,Object13,Connection14,Lambda15,Lambda16,PgSelect17,PgPageInfo18,Access20,Object21,Lambda22,Object25,Lambda26,PgSelect27,First28,PgSelectRows29,PgSelectSingle30,PgClassExpression31,Constant32,Constant33 bucket0
    end
