dist: xenial
language: node_js

node_js:
  - "12"
  - "14"

addons:
  postgresql: "10"
  apt:
    packages:
      - postgresql-server-dev-10

env:
  PGVERSION: 10
  TEST_DATABASE_URL: postgres://localhost:5432/graphileengine_test
  TEST_PG_URL: postgres://localhost:5432/postgraphile_test
  FORCE_COLOR: 1

cache: yarn

install:
  - npm install -g yarn
  - yarn --immutable
  - yarn build

before_script:
  - sudo bash -c "echo -e 'wal_level = logical\nmax_replication_slots =
    10\nmax_wal_senders = 10' >>
    /etc/postgresql/$PGVERSION/main/postgresql.conf"
  - sudo service postgresql stop
  - sudo service postgresql start $PGVERSION
  - git clone https://github.com/eulerto/wal2json.git
  - sudo bash -c "cd wal2json && USE_PGXS=1 make && USE_PGXS=1 make install"
  - createdb graphileengine_test
  - createdb postgraphile_test
  - createdb travis || true
  - psql -c "ALTER USER travis WITH PASSWORD 'travis';"

script:
  - scripts/ci

matrix:
  include:
    - addons:
        apt:
          packages:
            - postgresql-11
            - postgresql-client-11
            - postgresql-server-dev-11
        postgresql: 11
      services:
        - postgresql
      env:
        - PGVERSION=11
        - TEST_DATABASE_URL=postgres://localhost:5432/graphileengine_test
        - TEST_PG_URL=postgres://localhost:5432/postgraphile_test
        - LDS_TEST_DATABASE_URL=postgres://travis:travis@localhost:5432/lds_test
      sudo: false
      dist: xenial
